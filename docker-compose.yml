# ================================
# NETWORKS
# ================================
networks:
  a2sv-network:
    driver: bridge

# ================================
# VOLUMES (Persistent Data)
# ================================
volumes:
  mongo-data:
    driver: local
  redis-data:
    driver: local

# ================================
# SERVICES
# ================================
services:
  # ================================
  # MongoDB Database (with Replica Set)
  # ================================
  mongo:
    image: mongo:7.0
    container_name: a2sv-mongodb
    restart: unless-stopped
    command: ["--replSet", "rs0", "--bind_ip_all", "--noauth"]
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongo-data:/data/db
      - mongo-data:/data/configdb
    networks:
      - a2sv-network
    healthcheck:
      test: mongosh --eval 'db.adminCommand("ping")' || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ================================
  # MongoDB Replica Set Initialization
  # ================================
  mongo-init:
    image: mongo:7.0
    container_name: a2sv-mongodb-init
    depends_on:
      - mongo
    networks:
      - a2sv-network
    restart: "no"
    entrypoint: >
      bash -c "
        sleep 10 &&
        mongosh --host mongo:27017 --eval '
          try {
            rs.status();
            print(\"✅ Replica set already initialized\");
          } catch(e) {
            rs.initiate({
              _id: \"rs0\",
              members: [{ _id: 0, host: \"mongo:27017\" }]
            });
            print(\"✅ Replica set initialized successfully\");
            print(\"Waiting for primary election...\");
            sleep(2000);
            print(\"✅ MongoDB ready for transactions!\");
          }
        '
      "

  # ================================
  # Redis Cache
  # ================================
  redis:
    image: redis:7-alpine
    container_name: a2sv-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - a2sv-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}

  # ================================
  # Backend API Application
  # ================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    container_name: a2sv-backend
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Node Environment
      NODE_ENV: production
      PORT: ${PORT:-5000}
      
      # MongoDB Configuration
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongo:27017/${MONGO_DATABASE:-a2sv_ecommerce}?authSource=admin&replicaSet=rs0
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
      
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-1h}
      
      # Application Configuration
      API_VERSION: ${API_VERSION:-v1}
      
      # Security
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-10}
      
      # Pagination
      DEFAULT_PAGE_SIZE: ${DEFAULT_PAGE_SIZE:-10}
      MAX_PAGE_SIZE: ${MAX_PAGE_SIZE:-100}
    ports:
      - "${PORT:-5000}:5000"
    networks:
      - a2sv-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => {if (r.statusCode !== 200) throw new Error('Health check failed')})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    # Security: Run as non-root user
    user: "1001:1001"
    # Resource limits (optional but recommended for production)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
